name: Build & Release Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build plugin
        run: dotnet publish Jellyfin.Plugin.AdvancedSorting/Jellyfin.Plugin.AdvancedSorting.csproj --configuration Release --output ./output

      - name: Create plugin zip
        run: |
          cd output
          zip -j ../Jellyfin.Plugin.AdvancedSorting.zip Jellyfin.Plugin.AdvancedSorting.dll
          cd ..

      - name: Compute MD5 checksum
        id: checksum
        run: |
          CHECKSUM=$(md5sum Jellyfin.Plugin.AdvancedSorting.zip | awk '{print $1}')
          echo "md5=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update manifest.json
        run: |
          REPO_URL="https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/Jellyfin.Plugin.AdvancedSorting.zip"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S")

          # Use jq to update the manifest
          jq --arg ver "${{ steps.version.outputs.version }}" \
             --arg url "$REPO_URL" \
             --arg md5 "${{ steps.checksum.outputs.md5 }}" \
             --arg ts "$TIMESTAMP" \
             --arg owner "${{ github.repository_owner }}" \
             '.[0].owner = $owner |
              .[0].versions = [{
                version: $ver,
                changelog: "Release v" + $ver,
                targetAbi: "10.9.0.0",
                sourceUrl: $url,
                checksum: $md5,
                timestamp: $ts
              }] + .[0].versions' \
             manifest.json > manifest_updated.json
          mv manifest_updated.json manifest.json

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-zip
          path: Jellyfin.Plugin.AdvancedSorting.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Jellyfin.Plugin.AdvancedSorting.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit updated manifest
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main || git checkout master
          git add manifest.json
          git commit -m "Update manifest.json for release v${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
