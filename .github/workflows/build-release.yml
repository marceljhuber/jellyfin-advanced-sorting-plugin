name: Build & Release Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build plugin
        run: dotnet publish Jellyfin.Plugin.AdvancedSorting/Jellyfin.Plugin.AdvancedSorting.csproj --configuration Release --output ./output

      - name: Create plugin zip
        run: |
          cd output
          zip -j ../Jellyfin.Plugin.AdvancedSorting.zip Jellyfin.Plugin.AdvancedSorting.dll
          cd ..

      - name: Compute MD5 checksum
        id: checksum
        run: |
          CHECKSUM=$(md5sum Jellyfin.Plugin.AdvancedSorting.zip | awk '{print $1}')
          echo "md5=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update manifest.json
        run: |
          REPO_URL="https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/Jellyfin.Plugin.AdvancedSorting.zip"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S")
          VERSION="${{ steps.version.outputs.version }}"
          CHECKSUM="${{ steps.checksum.outputs.md5 }}"
          OWNER="${{ github.repository_owner }}"

          cat > manifest.json << MANIFEST_EOF
          [
              {
                  "guid": "b3f0e574-a91c-4f24-8b6a-7c1d9e2f5a80",
                  "name": "Advanced Sorting",
                  "description": "Adds advanced sorting capabilities to your Jellyfin library. Sort movies and videos by video bitrate, file size, community rating, and IMDb Top 250 ranking.",
                  "overview": "Sort by video bitrate, file size, community rating, and IMDb Top 250 rank",
                  "owner": "${OWNER}",
                  "category": "General",
                  "versions": [
                      {
                          "version": "${VERSION}",
                          "changelog": "Release v${VERSION}",
                          "targetAbi": "10.9.0.0",
                          "sourceUrl": "${REPO_URL}",
                          "checksum": "${CHECKSUM}",
                          "timestamp": "${TIMESTAMP}"
                      }
                  ]
              }
          ]
          MANIFEST_EOF

          cat manifest.json

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-zip
          path: Jellyfin.Plugin.AdvancedSorting.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: Jellyfin.Plugin.AdvancedSorting.zip
          generate_release_notes: true

      - name: Commit updated manifest
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main || git checkout master
          git add manifest.json
          git diff --cached --quiet && echo "No changes to commit" || (git commit -m "Update manifest.json for release v${{ steps.version.outputs.version }}" && git push)
