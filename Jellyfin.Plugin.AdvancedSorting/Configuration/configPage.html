<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Advanced Sorting</title>
</head>
<body>
    <div id="AdvancedSortingConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <h2>Advanced Sorting Plugin</h2>
                <p>This plugin adds additional sorting options to your Jellyfin library:</p>
                <ul>
                    <li><strong>Video Bitrate</strong> &mdash; Sort by video stream bitrate (available in sort menus)</li>
                    <li><strong>Community Rating</strong> &mdash; Sort by community/user rating (available in sort menus)</li>
                    <li><strong>File Size</strong> &mdash; Sort by total media file size (via API)</li>
                    <li><strong>IMDb Top 250</strong> &mdash; Sort by IMDb Top 250 ranking (via API)</li>
                </ul>

                <form id="AdvancedSortingConfigForm">
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnableImdbTopSorting" name="EnableImdbTopSorting" type="checkbox" is="emby-checkbox" />
                            <span>Enable IMDb Top 250 Sorting</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, movies will be matched against the IMDb Top 250 list for rank-based sorting.
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="ImdbTopListRefreshIntervalHours">
                            IMDb List Refresh Interval (hours)
                        </label>
                        <input id="ImdbTopListRefreshIntervalHours" name="ImdbTopListRefreshIntervalHours"
                               type="number" is="emby-input" min="1" max="720" />
                        <div class="fieldDescription">
                            How often (in hours) the IMDb Top 250 list cache should be refreshed. Default: 24 hours.
                        </div>
                    </div>

                    <br />
                    <h3>API Endpoints</h3>
                    <p>Use these REST API endpoints to retrieve sorted lists:</p>
                    <table class="tblSortEndpoints" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom: 1px solid #444;">
                                <th style="padding: 8px;">Endpoint</th>
                                <th style="padding: 8px;">Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 8px; font-family: monospace;">GET /AdvancedSorting/ByBitrate</td>
                                <td style="padding: 8px;">Sort movies by video bitrate. Params: ascending, limit</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 8px; font-family: monospace;">GET /AdvancedSorting/ByFileSize</td>
                                <td style="padding: 8px;">Sort movies by file size. Params: ascending, limit</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 8px; font-family: monospace;">GET /AdvancedSorting/ByCommunityRating</td>
                                <td style="padding: 8px;">Sort movies by community rating. Params: ascending, limit</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 8px; font-family: monospace;">GET /AdvancedSorting/ByImdbTopRank</td>
                                <td style="padding: 8px;">Sort movies by IMDb Top 250 rank. Params: includeUnranked, limit</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 8px; font-family: monospace;">GET /AdvancedSorting/ImdbTopList/Status</td>
                                <td style="padding: 8px;">Get current IMDb list status (entry count, last updated)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 8px; font-family: monospace;">POST /AdvancedSorting/ImdbTopList/Update</td>
                                <td style="padding: 8px;">Update the IMDb list with custom rankings (JSON body)</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; font-family: monospace;">POST /AdvancedSorting/ImdbTopList/Reset</td>
                                <td style="padding: 8px;">Reset the IMDb list to built-in defaults</td>
                            </tr>
                        </tbody>
                    </table>

                    <br />
                    <div id="imdbStatus" style="padding: 10px; margin-top: 10px; border: 1px solid #444; border-radius: 4px;">
                        <strong>IMDb Top List Status:</strong>
                        <span id="imdbStatusText">Loading...</span>
                    </div>

                    <br />
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var AdvancedSortingConfig = {
                pluginUniqueId: 'b3f0e574-a91c-4f24-8b6a-7c1d9e2f5a80'
            };

            document.querySelector('#AdvancedSortingConfigPage')
                .addEventListener('pageshow', function () {
                    Dashboard.showLoadingMsg();

                    // Load plugin config
                    ApiClient.getPluginConfiguration(AdvancedSortingConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#EnableImdbTopSorting').checked = config.EnableImdbTopSorting;
                        document.querySelector('#ImdbTopListRefreshIntervalHours').value = config.ImdbTopListRefreshIntervalHours;
                        Dashboard.hideLoadingMsg();
                    });

                    // Load IMDb status
                    ApiClient.fetch({
                        url: ApiClient.getUrl('AdvancedSorting/ImdbTopList/Status'),
                        type: 'GET',
                        dataType: 'json'
                    }).then(function (status) {
                        var lastUpdated = status.LastUpdated
                            ? new Date(status.LastUpdated).toLocaleString()
                            : 'Never';
                        document.querySelector('#imdbStatusText').textContent =
                            status.EntryCount + ' entries, last updated: ' + lastUpdated;
                    }).catch(function () {
                        document.querySelector('#imdbStatusText').textContent = 'Unable to load status';
                    });
                });

            document.querySelector('#AdvancedSortingConfigForm')
                .addEventListener('submit', function (e) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(AdvancedSortingConfig.pluginUniqueId).then(function (config) {
                        config.EnableImdbTopSorting = document.querySelector('#EnableImdbTopSorting').checked;
                        config.ImdbTopListRefreshIntervalHours =
                            parseInt(document.querySelector('#ImdbTopListRefreshIntervalHours').value, 10);

                        ApiClient.updatePluginConfiguration(AdvancedSortingConfig.pluginUniqueId, config)
                            .then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(result);
                            });
                    });

                    e.preventDefault();
                    return false;
                });
        </script>
    </div>
</body>
</html>
